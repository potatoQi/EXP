# å·¥ä½œæµåç§°,ç”¨äºå‘å¸ƒ Python åŒ…åˆ° PyPI
name: ğŸš€ Release to PyPI

# å®šä¹‰è§¦å‘æ­¤å·¥ä½œæµçš„äº‹ä»¶
on:
  push:  # å½“æ¨é€æ“ä½œå‘ç”Ÿæ—¶
    tags:  # ä¸”æ¨é€çš„æ˜¯æ ‡ç­¾(tag)æ—¶è§¦å‘
      - 'v*'  # åªåŒ¹é… v å¼€å¤´çš„æ ‡ç­¾,å¦‚ v0.0.1, v1.2.3 ç­‰

  workflow_dispatch:  # å…è®¸åœ¨ GitHub ç½‘é¡µä¸Šæ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
    inputs:  # æ‰‹åŠ¨è§¦å‘æ—¶éœ€è¦çš„è¾“å…¥å‚æ•°
      version:  # å‚æ•°åç§°
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (å¿…é¡»ä»¥ v å¼€å¤´,å¦‚ v0.0.3)'  # å‚æ•°æè¿°,æ˜¾ç¤ºåœ¨æ‰‹åŠ¨è§¦å‘ç•Œé¢
        required: true  # æ­¤å‚æ•°ä¸ºå¿…å¡«é¡¹
        type: string  # å‚æ•°ç±»å‹ä¸ºå­—ç¬¦ä¸²

# å®šä¹‰å·¥ä½œæµä¸­çš„æ‰€æœ‰ä»»åŠ¡
jobs:
  release:  # ä»»åŠ¡ ID
    runs-on: ubuntu-latest  # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°ç‰ˆ Ubuntu ç³»ç»Ÿ
    
    steps:  # å®šä¹‰ä»»åŠ¡ä¸­çš„å…·ä½“æ‰§è¡Œæ­¥éª¤
    - name: ğŸ“¥ æ£€å‡ºä»£ç   # æ­¥éª¤åç§°
      uses: actions/checkout@v4  # ä½¿ç”¨å®˜æ–¹ checkout action æ‹‰å–ä»“åº“ä»£ç 
    
    - name: ğŸ è®¾ç½® Python  # å®‰è£… Python ç¯å¢ƒ
      uses: actions/setup-python@v4  # ä½¿ç”¨å®˜æ–¹ Python å®‰è£… action
      with:  # ä¼ é€’å‚æ•°
        python-version: '3.11'  # æŒ‡å®šä½¿ç”¨ Python 3.11 ç‰ˆæœ¬
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–  # å®‰è£…æ‰“åŒ…å’Œå‘å¸ƒæ‰€éœ€çš„å·¥å…·
      run: |  # è¿è¡Œå¤šè¡Œ shell å‘½ä»¤
        python -m pip install --upgrade pip  # å‡çº§ pip åˆ°æœ€æ–°ç‰ˆæœ¬
        pip install build twine  # build: æ„å»ºå·¥å…·; twine: PyPI ä¸Šä¼ å·¥å…·
    
    - name: ğŸ”§ æ›´æ–°ç‰ˆæœ¬å· (æ‰‹åŠ¨è§¦å‘æ—¶)  # å½“æ‰‹åŠ¨è§¦å‘æ—¶è‡ªåŠ¨æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
      if: github.event_name == 'workflow_dispatch'  # æ¡ä»¶åˆ¤æ–­:ä»…å½“æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
      run: |  # è¿è¡Œå¤šè¡Œå‘½ä»¤
        VERSION="${{ github.event.inputs.version }}"  # è·å–æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬æ ‡ç­¾(å¦‚ v0.0.3)
        VERSION_NUMBER="${VERSION#v}"  # å»æ‰å¼€å¤´çš„ v,å¾—åˆ°çº¯æ•°å­—ç‰ˆæœ¬å·(å¦‚ 0.0.3)
        sed -i "s/version = \"[^\"]*\"/version = \"$VERSION_NUMBER\"/" pyproject.toml  # ä½¿ç”¨ sed å‘½ä»¤æ›¿æ¢ pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
        echo "å·²æ›´æ–°ç‰ˆæœ¬ä¸º: $VERSION_NUMBER (æ ‡ç­¾: $VERSION)"  # è¾“å‡ºæç¤ºä¿¡æ¯
    
    - name: ğŸ·ï¸ åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾ (æ‰‹åŠ¨è§¦å‘æ—¶)  # æ‰‹åŠ¨è§¦å‘æ—¶åˆ›å»º git æ ‡ç­¾
      if: github.event_name == 'workflow_dispatch'  # æ¡ä»¶åˆ¤æ–­:ä»…å½“æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
      run: |  # è¿è¡Œå¤šè¡Œå‘½ä»¤
        git config user.name "github-actions[bot]"  # é…ç½® git ç”¨æˆ·å
        git config user.email "github-actions[bot]@users.noreply.github.com"  # é…ç½® git é‚®ç®±
        git add pyproject.toml  # æš‚å­˜ä¿®æ”¹çš„æ–‡ä»¶
        git commit -m "chore: bump version to ${{ github.event.inputs.version }}"  # æäº¤ç‰ˆæœ¬æ›´æ–°
        git tag ${{ github.event.inputs.version }}  # åˆ›å»ºæ ‡ç­¾
        git push origin main  # æ¨é€æäº¤åˆ° main åˆ†æ”¯
        git push origin ${{ github.event.inputs.version }}  # æ¨é€æ ‡ç­¾
    
    - name: ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©  # æ¸…ç†ä¹‹å‰å¯èƒ½å­˜åœ¨çš„æ„å»ºæ–‡ä»¶,ç¡®ä¿å¹²å‡€çš„æ„å»ºç¯å¢ƒ
      run: rm -rf dist build *.egg-info  # åˆ é™¤ dist, build ç›®å½•å’Œ .egg-info æ–‡ä»¶
    
    - name: ğŸ“¦ æ„å»ºåŒ…  # æ„å»º Python åŒ…(ç”Ÿæˆ .whl å’Œ .tar.gz æ–‡ä»¶)
      run: python -m build  # ä½¿ç”¨ build æ¨¡å—æ„å»ºåŒ…,ä¼šåœ¨ dist/ ç›®å½•ç”Ÿæˆæ–‡ä»¶
    
    - name: ğŸ” éªŒè¯åŒ…  # éªŒè¯æ„å»ºçš„åŒ…æ˜¯å¦ç¬¦åˆ PyPI è§„èŒƒ
      run: twine check dist/*  # ä½¿ç”¨ twine æ£€æŸ¥ dist ç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…æ–‡ä»¶
    
    - name: ğŸ§ª æµ‹è¯•å®‰è£…  # åœ¨è™šæ‹Ÿç¯å¢ƒä¸­æµ‹è¯•åŒ…æ˜¯å¦èƒ½æ­£å¸¸å®‰è£…å’Œå¯¼å…¥
      run: |  # è¿è¡Œå¤šè¡Œå‘½ä»¤
        python -m venv test_env  # åˆ›å»ºä¸€ä¸ªä¸´æ—¶è™šæ‹Ÿç¯å¢ƒ
        source test_env/bin/activate  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
        pip install dist/*.whl  # å®‰è£…åˆšæ„å»ºçš„ wheel åŒ…
        python -c "from experiment_manager.core import Experiment; print('âœ… å¯¼å…¥æµ‹è¯•é€šè¿‡')"  # æµ‹è¯•æ˜¯å¦èƒ½æˆåŠŸå¯¼å…¥ä¸»è¦æ¨¡å—
        deactivate  # é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
        rm -rf test_env  # åˆ é™¤ä¸´æ—¶è™šæ‹Ÿç¯å¢ƒ
    
    - name: ğŸš€ å‘å¸ƒåˆ° PyPI  # å°†åŒ…ä¸Šä¼ åˆ° PyPI(Python Package Index)
      env:  # è®¾ç½®ç¯å¢ƒå˜é‡
        TWINE_USERNAME: __token__  # PyPI ä½¿ç”¨ token è®¤è¯æ—¶,ç”¨æˆ·åå›ºå®šä¸º __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}  # ä» GitHub Secrets ä¸­è·å– PyPI API Token
      run: twine upload dist/*  # ä½¿ç”¨ twine ä¸Šä¼  dist ç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…æ–‡ä»¶åˆ° PyPI